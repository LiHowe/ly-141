# WinmTech-SCADA 模块开发指南

## 概述

本指南将帮助您了解如何在 WinmTech-SCADA 系统中开发和使用模块。系统采用模块化架构，支持动态加载、配置管理、数据库表创建等企业级功能。

## 模块系统架构

### 核心组件

1. **IModule 接口** - 定义模块的基本契约
2. **ModuleBase 基类** - 提供模块的基础实现
3. **ModuleManager** - 负责模块的生命周期管理
4. **IModuleDatabaseService** - 提供模块级别的数据库服务
5. **ModuleConfiguration** - 模块配置管理

### 模块生命周期

```
注册 → 初始化 → 数据库初始化 → 启用 → 运行 → 禁用 → 卸载
```

## 快速开始

### 1. 创建模块项目

创建一个新的 .NET 类库项目，并添加对 Core 项目的引用：

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net9.0-windows</TargetFramework>
    <UseWPF>true</UseWPF>
  </PropertyGroup>
  
  <ItemGroup>
    <ProjectReference Include="..\Core\Core.csproj" />
  </ItemGroup>
</Project>
```

### 2. 创建数据模型（可选）

如果模块需要数据库支持，创建继承自 `RecordBase` 的数据模型：

```csharp
using Core.Models;
using SqlSugar;

namespace MyModule.Models
{
    /// <summary>
    /// 我的数据记录
    /// </summary>
    public class MyDataRecord : RecordBase
    {
        /// <summary>
        /// 业务字段
        /// </summary>
        [SugarColumn(ColumnDescription = "业务字段", Length = 100)]
        public string? BusinessField { get; set; }

        /// <summary>
        /// 数值字段
        /// </summary>
        [SugarColumn(ColumnDescription = "数值字段")]
        public decimal Amount { get; set; }
    }
}
```

### 3. 创建模块主类

```csharp
using Core.Models;
using MyModule.Models;

namespace MyModule
{
    /// <summary>
    /// 我的业务模块
    /// </summary>
    public class MyBusinessModule : ModuleBase
    {
        public override string ModuleId => "MyModule.Business";
        public override string ModuleName => "我的业务模块";
        public override string Version => "1.0.0";
        public override string Description => "这是一个示例业务模块";

        /// <summary>
        /// 定义模块需要的数据库表
        /// </summary>
        public override List<Type> GetDatabaseTableTypes()
        {
            return new List<Type>
            {
                typeof(MyDataRecord)
            };
        }

        /// <summary>
        /// 模块初始化
        /// </summary>
        public override async Task<bool> OnInitializeAsync()
        {
            OnInfo("开始初始化我的业务模块");
            
            // 执行模块特定的初始化逻辑
            await InitializeBusinessLogicAsync();
            
            OnInfo("我的业务模块初始化完成");
            return true;
        }

        /// <summary>
        /// 数据库初始化完成后的回调
        /// </summary>
        public override async Task<bool> OnDatabaseInitializeAsync()
        {
            // 插入初始数据或执行数据库相关的初始化
            return await ExecuteDatabaseOperationAsync(async db =>
            {
                // 检查是否需要插入初始数据
                var count = await db.Queryable<MyDataRecord>().CountAsync();
                if (count == 0)
                {
                    // 插入初始数据
                    await db.Insertable(new MyDataRecord
                    {
                        BusinessField = "初始数据",
                        Amount = 100.00m
                    }).ExecuteCommandAsync();
                }
            });
        }

        /// <summary>
        /// 模块启用时调用
        /// </summary>
        public override async Task OnEnabledAsync()
        {
            OnInfo("模块已启用");
            // 启动业务逻辑
            await StartBusinessProcessAsync();
        }

        /// <summary>
        /// 模块禁用时调用
        /// </summary>
        public override async Task OnDisabledAsync()
        {
            OnInfo("模块已禁用");
            // 停止业务逻辑
            await StopBusinessProcessAsync();
        }

        /// <summary>
        /// 模块关闭时调用
        /// </summary>
        public override async Task OnShutdownAsync()
        {
            OnInfo("模块正在关闭");
            // 清理资源
            await CleanupResourcesAsync();
        }

        #region 私有方法

        private async Task InitializeBusinessLogicAsync()
        {
            // 实现业务逻辑初始化
            await Task.CompletedTask;
        }

        private async Task StartBusinessProcessAsync()
        {
            // 启动业务流程
            await Task.CompletedTask;
        }

        private async Task StopBusinessProcessAsync()
        {
            // 停止业务流程
            await Task.CompletedTask;
        }

        private async Task CleanupResourcesAsync()
        {
            // 清理模块资源
            await Task.CompletedTask;
        }

        #endregion
    }
}
```

### 4. 创建用户界面（可选）

如果模块需要用户界面，创建 WPF 用户控件：

```csharp
// MyModuleControl.xaml.cs
using System.Windows.Controls;

namespace MyModule.Controls
{
    public partial class MyModuleControl : UserControl
    {
        public MyModuleControl()
        {
            InitializeComponent();
            DataContext = new MyModuleViewModel();
        }
    }
}
```

### 5. 创建模块配置文件

在模块项目根目录创建 `module.json` 配置文件：

```json
{
  "moduleId": "MyModule.Business",
  "name": "我的业务模块",
  "version": "1.0.0",
  "description": "这是一个示例业务模块",
  "enabled": true,
  "priority": 100,
  "dependencies": [],
  "parameters": {
    "setting1": "value1",
    "setting2": 123
  },
  "database": {
    "enableDatabase": true,
    "autoCreateTables": true,
    "dropTablesOnUnload": false,
    "tablePrefix": "MyModule",
    "migrationSettings": {
      "enableAutoMigration": true,
      "migrationScriptsPath": "Migrations",
      "backupBeforeMigration": true
    }
  }
}
```

## 数据库操作

### 基础数据库操作

模块基类提供了便捷的数据库操作方法：

```csharp
// 安全的数据库操作
var result = await ExecuteDatabaseOperationAsync(async db =>
{
    return await db.Queryable<MyDataRecord>()
                   .Where(x => x.BusinessField.Contains("关键词"))
                   .ToListAsync();
}, new List<MyDataRecord>());

// 无返回值的数据库操作
var success = await ExecuteDatabaseOperationAsync(async db =>
{
    await db.Insertable(new MyDataRecord
    {
        BusinessField = "新数据",
        Amount = 200.00m
    }).ExecuteCommandAsync();
});
```

### 直接访问数据库连接

```csharp
if (IsDatabaseConnectionAvailable())
{
    var db = GetDatabaseConnection();
    // 使用数据库连接进行操作
}
```

## 模块配置

### 读取配置参数

```csharp
public override async Task<bool> OnInitializeAsync()
{
    // 从配置中读取参数
    if (Configuration?.Parameters?.TryGetValue("setting1", out var value) == true)
    {
        var setting1 = value.ToString();
        OnInfo($"配置参数 setting1: {setting1}");
    }
    
    return await base.OnInitializeAsync();
}
```

### 动态修改配置

```csharp
// 通过 ModuleManager 获取和修改配置
var moduleManager = ServiceLocator.GetService<IModuleManager>();
var config = await moduleManager.GetModuleConfigurationAsync(ModuleId);
if (config != null)
{
    config.Parameters["newSetting"] = "newValue";
    await moduleManager.SaveModuleConfigurationAsync(config);
}
```

## 事件和通信

### 模块间通信

```csharp
// 发布事件
OnModuleEvent("DataUpdated", new { RecordId = 123, Action = "Insert" });

// 监听其他模块事件
protected override void OnModuleEventReceived(string eventName, object eventData)
{
    switch (eventName)
    {
        case "SystemStatusChanged":
            HandleSystemStatusChanged(eventData);
            break;
    }
}
```

### 状态变化通知

```csharp
// 模块状态变化时会自动触发事件
// 可以在主程序中监听这些事件
moduleManager.ModuleStatusChanged += (sender, args) =>
{
    Console.WriteLine($"模块 {args.ModuleId} 状态从 {args.OldStatus} 变更为 {args.NewStatus}");
};
```

## 最佳实践

### 1. 错误处理

```csharp
public override async Task<bool> OnInitializeAsync()
{
    try
    {
        // 初始化逻辑
        await InitializeBusinessLogicAsync();
        return true;
    }
    catch (Exception ex)
    {
        OnError("模块初始化失败", ex);
        return false;
    }
}
```

### 2. 资源管理

```csharp
public override async Task OnShutdownAsync()
{
    try
    {
        // 停止定时器
        _timer?.Stop();
        _timer?.Dispose();
        
        // 关闭连接
        _connection?.Close();
        
        // 清理数据库资源
        await CleanupDatabaseResourcesAsync();
    }
    catch (Exception ex)
    {
        OnError("资源清理失败", ex);
    }
}
```

### 3. 异步编程

```csharp
// 优先使用异步方法
public override async Task<bool> OnInitializeAsync()
{
    // 使用 ConfigureAwait(false) 避免死锁
    await InitializeAsync().ConfigureAwait(false);
    return true;
}
```

### 4. 日志记录

```csharp
// 使用模块基类提供的日志方法
OnInfo("信息日志");
OnWarning("警告日志");
OnError("错误日志", exception);
```

## 调试和测试

### 1. 单元测试

```csharp
[Test]
public async Task TestModuleInitialization()
{
    var module = new MyBusinessModule();
    var result = await module.OnInitializeAsync();
    Assert.IsTrue(result);
}
```

### 2. 集成测试

```csharp
[Test]
public async Task TestModuleWithDatabase()
{
    var moduleManager = new ModuleManager();
    await moduleManager.RegisterModuleAsync(new MyBusinessModule());
    
    var result = await moduleManager.InitializeAllModulesAsync();
    Assert.IsTrue(result.SuccessCount > 0);
}
```

## 部署和分发

### 1. 编译输出

模块编译后的 DLL 文件应放置在主程序的 `Modules` 目录下。

### 2. 配置文件

确保 `module.json` 配置文件与 DLL 文件在同一目录。

### 3. 依赖管理

如果模块有额外的依赖项，确保这些依赖项也被复制到输出目录。

## 故障排除

### 常见问题

1. **模块加载失败**
   - 检查 DLL 文件是否在正确位置
   - 验证配置文件格式是否正确
   - 查看日志文件中的错误信息

2. **数据库表创建失败**
   - 确保数据模型正确继承 `RecordBase`
   - 检查数据库连接配置
   - 验证数据库权限

3. **模块初始化超时**
   - 检查初始化逻辑是否有阻塞操作
   - 使用异步方法避免阻塞
   - 增加超时时间配置

### 日志分析

系统会在以下位置记录详细日志：
- 应用程序日志目录
- 模块特定的日志文件
- 数据库操作日志

通过分析这些日志可以快速定位问题。
