# 模块使用示例

## 返修模块使用示例

基于您当前的返修模块，以下是完整的使用示例：

### 1. 返修模块的MVVM实现

#### ViewModel 示例

```csharp
// Module.Business.Repair/ViewModels/RepairControlViewModel.cs
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Runtime.CompilerServices;
using System.Windows.Input;

namespace Module.Business.Repair.ViewModels
{
    public class RepairControlViewModel : INotifyPropertyChanged
    {
        private ObservableCollection<RepairRecordViewModel> _repairRecords = new();
        private bool _isLoading;

        public ObservableCollection<RepairRecordViewModel> RepairRecords
        {
            get => _repairRecords;
            set { _repairRecords = value; OnPropertyChanged(); }
        }

        public bool IsLoading
        {
            get => _isLoading;
            set { _isLoading = value; OnPropertyChanged(); }
        }

        public ICommand RefreshCommand { get; }
        public ICommand AddRecordCommand { get; }

        public RepairControlViewModel()
        {
            RefreshCommand = new RelayCommand(async () => await LoadDataAsync());
            AddRecordCommand = new RelayCommand(async () => await AddNewRecordAsync());
            
            _ = LoadDataAsync(); // 初始化时加载数据
        }

        private async Task LoadDataAsync()
        {
            try
            {
                IsLoading = true;
                
                // 从数据库加载返修记录
                var records = await GetRepairRecordsFromDatabaseAsync();
                
                RepairRecords.Clear();
                foreach (var record in records)
                {
                    RepairRecords.Add(new RepairRecordViewModel(record));
                }
            }
            catch (Exception ex)
            {
                // 处理错误
                ShowErrorMessage($"加载数据失败: {ex.Message}");
            }
            finally
            {
                IsLoading = false;
            }
        }

        private async Task AddNewRecordAsync()
        {
            try
            {
                var newRecord = new RepairRecord
                {
                    PartCode = GeneratePartCode(),
                    UnloadTime = DateTime.Now,
                    LoadTime = null
                };

                // 保存到数据库
                await SaveRecordToDatabaseAsync(newRecord);
                
                // 添加到UI
                RepairRecords.Add(new RepairRecordViewModel(newRecord));
                
                ShowInfoMessage("新增返修记录成功");
            }
            catch (Exception ex)
            {
                ShowErrorMessage($"新增记录失败: {ex.Message}");
            }
        }

        // 其他方法...
        public event PropertyChangedEventHandler? PropertyChanged;
        protected virtual void OnPropertyChanged([CallerMemberName] string? propertyName = null)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }

    public class RepairRecordViewModel : INotifyPropertyChanged
    {
        private readonly RepairRecord _record;

        public RepairRecordViewModel(RepairRecord record)
        {
            _record = record;
            MarkAsLoadedCommand = new RelayCommand(async () => await MarkAsLoadedAsync());
        }

        public int Id => _record.Id;
        public string PartCode => _record.PartCode ?? "未知";
        public DateTime UnloadTime => _record.UnloadTime;
        public DateTime? LoadTime => _record.LoadTime;
        
        public string UnloadTimeText => UnloadTime.ToString("yyyy-MM-dd HH:mm:ss");
        public string LoadTimeText => LoadTime?.ToString("yyyy-MM-dd HH:mm:ss") ?? "-";
        public bool IsLoaded => LoadTime.HasValue;
        public string StatusText => IsLoaded ? "已上料" : "待上料";
        public string StatusStyleKey => IsLoaded ? "SuccessStatusIndicator" : "DangerStatusIndicator";

        public ICommand MarkAsLoadedCommand { get; }

        private async Task MarkAsLoadedAsync()
        {
            if (!IsLoaded)
            {
                _record.LoadTime = DateTime.Now;
                // 更新数据库
                await UpdateRecordInDatabaseAsync(_record);
                
                // 通知UI更新
                OnPropertyChanged(nameof(LoadTime));
                OnPropertyChanged(nameof(LoadTimeText));
                OnPropertyChanged(nameof(IsLoaded));
                OnPropertyChanged(nameof(StatusText));
                OnPropertyChanged(nameof(StatusStyleKey));
            }
        }

        public event PropertyChangedEventHandler? PropertyChanged;
        protected virtual void OnPropertyChanged([CallerMemberName] string? propertyName = null)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }
}
```

#### XAML 界面示例

```xml
<!-- Module.Business.Repair/RepairControl.xaml -->
<UserControl x:Class="Module.Business.Repair.RepairControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:hc="https://handyorg.github.io/handycontrol">
    
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="Styles/RepairControlStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>
    
    <Grid Margin="8">
        <hc:Card Padding="0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="50" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                
                <!-- 头部 -->
                <Border Grid.Row="0" BorderThickness="0,0,0,1" 
                        BorderBrush="{DynamicResource BorderBrush}" Padding="16,12">
                    <Grid>
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <TextBlock Style="{StaticResource IconText}" Text="&#xe678;" 
                                       FontSize="18" Margin="0,0,12,0"/>
                            <TextBlock Text="返修台" FontSize="18" FontWeight="Medium" 
                                       Foreground="{DynamicResource TextPrimaryBrush}"/>
                        </StackPanel>
                        
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Content="新增" Command="{Binding AddRecordCommand}" 
                                    Style="{StaticResource PrimaryButton}" Margin="0,0,8,0"/>
                            <Button Command="{Binding RefreshCommand}" 
                                    Style="{StaticResource RefreshButton}">
                                <TextBlock Style="{StaticResource IconText}" Text="&#xe72c;" FontSize="16"/>
                            </Button>
                        </StackPanel>
                    </Grid>
                </Border>
                
                <!-- 内容区域 -->
                <Grid Grid.Row="1">
                    <!-- 加载状态 -->
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center"
                                Visibility="{Binding IsLoading, Converter={StaticResource Boolean2VisibilityConverter}}">
                        <hc:LoadingCircle/>
                        <TextBlock Text="正在加载..." Margin="0,10,0,0" HorizontalAlignment="Center"/>
                    </StackPanel>
                    
                    <!-- 数据列表 -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="16"
                                  Visibility="{Binding IsLoading, Converter={StaticResource Boolean2VisibilityConverter}, ConverterParameter=true}">
                        <ItemsControl ItemsSource="{Binding RepairRecords}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Style="{StaticResource RepairRecordCard}">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="32"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <!-- 状态指示器 -->
                                            <Border Grid.Column="0" 
                                                    Style="{DynamicResource {Binding StatusStyleKey}}"
                                                    Margin="0,8,16,0" VerticalAlignment="Top"/>
                                            
                                            <!-- 内容区域 -->
                                            <StackPanel Grid.Column="1">
                                                <!-- 零件码 -->
                                                <TextBlock Text="{Binding PartCode}" 
                                                           Style="{StaticResource PartCodeText}"/>
                                                
                                                <!-- 状态信息 -->
                                                <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                                    <TextBlock Text="状态:" Style="{StaticResource LabelText}"/>
                                                    <TextBlock Text="{Binding StatusText}" 
                                                               Style="{StaticResource ValueText}"/>
                                                </StackPanel>
                                                
                                                <!-- 下料时间 -->
                                                <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                                    <TextBlock Text="下料时间:" Style="{StaticResource LabelText}"/>
                                                    <TextBlock Text="{Binding UnloadTimeText}" 
                                                               Style="{StaticResource ValueText}"/>
                                                </StackPanel>
                                                
                                                <!-- 上料时间 -->
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="上料时间:" Style="{StaticResource LabelText}"/>
                                                    <TextBlock Text="{Binding LoadTimeText}">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock" BasedOn="{StaticResource ValueText}">
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding LoadTimeText}" Value="-">
                                                                        <Setter Property="Foreground" 
                                                                                Value="{DynamicResource TextIconBrush}"/>
                                                                        <Setter Property="FontStyle" Value="Italic"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </StackPanel>
                                            </StackPanel>
                                            
                                            <!-- 操作按钮 -->
                                            <Button Grid.Column="2" Content="标记上料" 
                                                    Command="{Binding MarkAsLoadedCommand}"
                                                    IsEnabled="{Binding IsLoaded, Converter={StaticResource InverseBooleanConverter}}"
                                                    Style="{StaticResource AccentButton}"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                            
                            <!-- 空数据提示 -->
                            <ItemsControl.Style>
                                <Style TargetType="ItemsControl">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding RepairRecords.Count}" Value="0">
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate>
                                                        <StackPanel HorizontalAlignment="Center" 
                                                                    VerticalAlignment="Center" Margin="50">
                                                            <TextBlock Style="{StaticResource IconText}" 
                                                                       Text="&#xe7c3;" FontSize="48" 
                                                                       Foreground="{DynamicResource TextIconBrush}"
                                                                       HorizontalAlignment="Center"/>
                                                            <TextBlock Text="暂无返修记录" FontSize="16" 
                                                                       Foreground="{DynamicResource TextIconBrush}"
                                                                       HorizontalAlignment="Center" Margin="0,10,0,0"/>
                                                        </StackPanel>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ItemsControl.Style>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Grid>
        </hc:Card>
    </Grid>
</UserControl>
```

### 2. 在主程序中使用返修模块

#### 菜单配置示例

```csharp
// MainApp/MenuDefinition.cs
public static class MenuDefinition
{
    public static List<MenuConfig> GetMenuConfigs()
    {
        return new List<MenuConfig>
        {
            new MenuConfig
            {
                Text = "返修管理",
                Image = "&#xe678;",
                ViewType = typeof(RepairControl),
                Initializer = async (view) =>
                {
                    // 获取返修模块实例
                    var moduleManager = ServiceLocator.GetService<IModuleManager>();
                    var repairModule = moduleManager.GetModule("Module.Business.Repair");
                    
                    if (repairModule != null && repairModule.IsEnabled)
                    {
                        // 创建返修控件
                        var repairControl = new RepairControl();
                        view.AddControl(repairControl, 0, 0);
                    }
                    else
                    {
                        // 显示模块未启用提示
                        var errorControl = new TextBlock
                        {
                            Text = "返修模块未启用",
                            HorizontalAlignment = HorizontalAlignment.Center,
                            VerticalAlignment = VerticalAlignment.Center
                        };
                        view.AddControl(errorControl, 0, 0);
                    }
                }
            }
        };
    }
}
```

### 3. 数据库操作示例

#### 在模块中实现数据库操作

```csharp
// Module.Business.Repair/Services/RepairService.cs
public class RepairService
{
    private readonly ModuleBase _module;

    public RepairService(ModuleBase module)
    {
        _module = module;
    }

    public async Task<List<RepairRecord>> GetAllRecordsAsync()
    {
        return await _module.ExecuteDatabaseOperationAsync(async db =>
        {
            return await db.Queryable<RepairRecord>()
                          .OrderByDescending(x => x.CreateTime)
                          .ToListAsync();
        }, new List<RepairRecord>());
    }

    public async Task<bool> AddRecordAsync(RepairRecord record)
    {
        return await _module.ExecuteDatabaseOperationAsync(async db =>
        {
            await db.Insertable(record).ExecuteCommandAsync();
        });
    }

    public async Task<bool> UpdateRecordAsync(RepairRecord record)
    {
        return await _module.ExecuteDatabaseOperationAsync(async db =>
        {
            await db.Updateable(record).ExecuteCommandAsync();
        });
    }

    public async Task<bool> DeleteRecordAsync(int recordId)
    {
        return await _module.ExecuteDatabaseOperationAsync(async db =>
        {
            await db.Deleteable<RepairRecord>()
                    .Where(x => x.Id == recordId)
                    .ExecuteCommandAsync();
        });
    }

    public async Task<List<RepairRecord>> SearchRecordsAsync(string partCode, DateTime? startDate, DateTime? endDate)
    {
        return await _module.ExecuteDatabaseOperationAsync(async db =>
        {
            var query = db.Queryable<RepairRecord>();

            if (!string.IsNullOrWhiteSpace(partCode))
            {
                query = query.Where(x => x.PartCode.Contains(partCode));
            }

            if (startDate.HasValue)
            {
                query = query.Where(x => x.UnloadTime >= startDate.Value);
            }

            if (endDate.HasValue)
            {
                query = query.Where(x => x.UnloadTime <= endDate.Value);
            }

            return await query.OrderByDescending(x => x.CreateTime).ToListAsync();
        }, new List<RepairRecord>());
    }
}
```

### 4. 模块间通信示例

#### 发布事件

```csharp
// 在返修模块中发布事件
public class RepairBusinessModule : ModuleBase
{
    private RepairService _repairService;

    public override async Task<bool> OnInitializeAsync()
    {
        _repairService = new RepairService(this);
        
        // 监听零件下料事件
        SubscribeToEvent("PartUnloaded", OnPartUnloaded);
        
        return await base.OnInitializeAsync();
    }

    private async void OnPartUnloaded(object eventData)
    {
        if (eventData is PartUnloadedEventArgs args)
        {
            // 创建返修记录
            var repairRecord = new RepairRecord
            {
                PartCode = args.PartCode,
                UnloadTime = args.UnloadTime
            };

            await _repairService.AddRecordAsync(repairRecord);
            
            // 发布返修记录创建事件
            OnModuleEvent("RepairRecordCreated", new { RecordId = repairRecord.Id, PartCode = args.PartCode });
        }
    }
}
```

#### 监听事件

```csharp
// 在其他模块中监听返修事件
public class QualityModule : ModuleBase
{
    public override async Task<bool> OnInitializeAsync()
    {
        // 监听返修记录创建事件
        SubscribeToEvent("RepairRecordCreated", OnRepairRecordCreated);
        
        return await base.OnInitializeAsync();
    }

    private void OnRepairRecordCreated(object eventData)
    {
        if (eventData is dynamic data)
        {
            OnInfo($"检测到返修记录创建: 零件码 {data.PartCode}, 记录ID {data.RecordId}");
            
            // 执行质量检查逻辑
            _ = Task.Run(async () => await PerformQualityCheckAsync(data.PartCode));
        }
    }
}
```

### 5. 配置管理示例

#### 模块配置文件

```json
{
  "moduleId": "Module.Business.Repair",
  "name": "返修业务模块",
  "version": "1.0.0",
  "enabled": true,
  "priority": 100,
  "parameters": {
    "maxRetryCount": 3,
    "autoRefreshInterval": 30,
    "enableNotifications": true,
    "defaultPartCodePrefix": "RP"
  },
  "database": {
    "enableDatabase": true,
    "autoCreateTables": true,
    "tablePrefix": "Repair",
    "dropTablesOnUnload": false
  }
}
```

#### 读取和使用配置

```csharp
public class RepairBusinessModule : ModuleBase
{
    private int _maxRetryCount;
    private int _autoRefreshInterval;
    private bool _enableNotifications;
    private string _defaultPartCodePrefix;

    public override async Task<bool> OnInitializeAsync()
    {
        // 读取配置参数
        LoadConfiguration();
        
        // 根据配置初始化功能
        if (_enableNotifications)
        {
            InitializeNotificationService();
        }

        return await base.OnInitializeAsync();
    }

    private void LoadConfiguration()
    {
        if (Configuration?.Parameters != null)
        {
            _maxRetryCount = GetConfigValue<int>("maxRetryCount", 3);
            _autoRefreshInterval = GetConfigValue<int>("autoRefreshInterval", 30);
            _enableNotifications = GetConfigValue<bool>("enableNotifications", true);
            _defaultPartCodePrefix = GetConfigValue<string>("defaultPartCodePrefix", "RP");
        }
    }

    private T GetConfigValue<T>(string key, T defaultValue)
    {
        if (Configuration?.Parameters?.TryGetValue(key, out var value) == true)
        {
            try
            {
                return (T)Convert.ChangeType(value, typeof(T));
            }
            catch
            {
                OnWarning($"配置参数 {key} 类型转换失败，使用默认值");
            }
        }
        return defaultValue;
    }
}
```

这些示例展示了如何在实际项目中使用模块系统，包括MVVM模式的UI实现、数据库操作、模块间通信和配置管理等核心功能。
